---
title: 总揽
lang: zh-CN
---
# 总揽

大部分现代应用差不多是如下的样子:

![nosecurity](~@intrimg/585526-20170730210302068-1103356180.png)

所涉及主要的交互包括:

* Web 应用与浏览器之间通讯
* Web 应用与 web APIs 之间通讯(包括应用自身通讯和代表用户的操作)
* 基于浏览器的应用与 web APIs 之间通讯
* 原生应用与 web APIs 之间通讯
* 服务端应用与 web APIs 之间通讯
* 不同 web APIs 之间通讯(包括应用自身通讯和代表用户的操作)

每一层（前端、中间层及后端）都必须通过实现认证及授权功能对资源进行保护，这些通常运行在相同的用户存储上。

把这类基础的安全功能交给一个 security token (安全令牌) 服务, 可以减少在不同应用和端点 (endpoints) 上的重复开发.

重新组织一下这些应用以支持 security token 服务，体现在如下的架构和协议：

![securitycase](~@intrimg/585526-20170730210318005-958743848.png)

以上设计安全划分成两个部分:

## **身份认证**

当应用程序需要确认当前用户的身份时，需要使用身份认证功能. 通常这类应用程序管理着用户数据，并需要确保用户只能访问到其所有权限访问的数据. 最常见的例子是 web 应用程序，而原生或者用js开发的应用程序同样需要进行身份认证.

最常见的身份认证协议是 SAML2p、 WS-Federation 及 OpenID Connect，其中 SAML2p 最为流行和广泛部署.

以上三种协议中，OpenID Connect 协议是最新的，由于其对现代应用程序最有潜力，因而也是被认为最具前景的身份认证协议. 该协议一开始就是为移动应用场景设计的，所对于 API 访问方式被设计得十分友好.

## **API 访问控制**

应用程序有两个基础的方式来与 API 通讯：使用应用程序自己的身份，或者代理某个用户的身份. 有时，应用会把两种方式绑定在一起使用. 

OAuth2 协议被应用程序用来向 security token 服务请求 access token，借此来与 API 进行通讯. 由于身份认证与授权被统一化了，使得这种代理方式降低了客户端与 API 本身的复杂性.

## **OpenID Connect 与 OAuth 2.0 相得益彰**

OpenID Connect 与 OAuth 2.0 非常相似 – **OpenID Connect 实际上是建立在 OAuth 2.0 之上的扩展**. 从此两个基础的安全问题（身份认证与 API 访问控制）被合并为一个协议 - 通常这只是与 security token 服务的一次往返交互.

我们相信, 在可预见的未来，把 OpenID Connect 和 OAuth 2.0 合并起来是对于现代应用程序的安全而言是最佳选择. IdentityServer4 对上述两个协议进行了实现，并针对移动应用、原生应用和 web 应用的典型安全问题的解决方案进行了高度优化.

## **IdentityServer4 如何从中相助**

IdentityServer 作为一种中间件，它可以把符合规格的 OpenID Connect 与 OAuth 2.0 端点 (endpoints) 添加到任何 ASP.NET 应用程序中.

通常, 我们会构建（或者重用）一个包含登录及登出页面的应用程序, 而 IdentityServer 作为中间件会添加必要的协议头到这个页面, 于是，客户端应用程序都能通过标准协议与之建立沟通.

![idshelp](~@intrimg/585526-20170730211443349-584041189.png)

无论 IdentityServer 宿主应用程序有多么复杂, 我们通常建议将受到攻击的页面尽可能缩小，即只包含身份认证相关的界面元素.